# Querying the Data Store

This document uses some sample SQL statements to demonstrate typical queries against the CELCAT Data Store, and in so doing describes the structure and content of the store. Where possible the sample query is shown followed by an extract of the results.

## Simple Room List

This simple query illustrates that the Data Store contains denormalised  data that may help simplify some reporting requirements. Note that the dept and site names are available without joins.

``` SQL
SELECT
 room_id,
 unique_name,
 dept_name,
 site_name
FROM RESOURCE.ROOM
```

_.room_id | _.unique_name | _.dept_name | _.site_name
--- | --- | --- | ---
1 | A117 | Biology | Abbey End
2 | A308 | Portuguese | Abbey End
3 | A735 | Human Nutrition | Abbey End
4 | A815|  Business and Management Studies | Abbey End

## Event Instances

This query gets all event instances for the morning of 7th Sept 2015. Room names are included via a single join. Note that the event instance id is a string type and comprises the event id followed by a hyphen and then an integer representing the week of the event in the original timetable.

``` SQL
SELECT
 e.event_instance_id,
 e.start_time,
 e.end_time,
 e.event_cat_name,
 e.dept_name,
 er.room_unique_name
FROM EVENT.EVENT_INSTANCE e
LEFT OUTER JOIN EVENT.EVENT_ROOM er
 ON e.event_instance_id = er.event_instance_id
WHERE e.start_time >= '2015-09-07 09:00'
AND e.end_time <= '2015-09-07 12:00'
```

_.event_instance_id | _.start_time | _.end_time | _.event_cat_name | _.dept_name | _.room_unique_name
--- | --- | --- | --- | --- | ---
4482-0 | 2015-09-07 11:00:00.000 | 2015-09-07 12:00:00.000 | Seminar | Italian |  Beeston Room
4719-0 | 2015-09-07 09:00:00.000 | 2015-09-07 10:30:00.000 | Seminar | German | Thetford Room
4468-0 | 2015-09-07 09:00:00.000 | 2015-09-07 10:15:00.000 | Symposium |Computing | Allington Room
4723-0 | 2015-09-07 09:00:00.000 | 2015-09-07 10:00:00.000 | Symposium | Education | Lewes Room
4692-0 | 2015-09-07 10:00:00.000 | 2015-09-07 11:00:00.000 | Seminar | Design | Thames Room

## Attendance

This query gets comprehensive register details for a given event instance. Note that the REGISTER_MARK table has no direct correspondence to a single CT7 database table - it is generated by CTDS from multiple CT7 source tables in order to simplify the querying of attendance data. The following query would require joins between many tables in the CT7 schema (including attendance exception tables).

``` SQL
--LP COMBINE ATTENDANCE DATA FROM CT_AT_STUDENT_MARK, CT_AT_STUDENT_REGISTER, CT_AT_EXCEPTION

SELECT sm.student_id, sm.event_id, sm.week, sm.mark_id, sm.mins_late,
sm.source
FROM CT_AT_STUDENT_MARK sm

UNION ALL

SELECT sr.student_id, sr.event_id, sr.week, e.mark_id, e.mins_late, e.type
FROM CT_AT_STUDENT_REGISTER sr
LEFT OUTER JOIN CT_AT_EXCEPTION e
ON sr.exception_id = e.exception_id
WHERE NOT EXISTS
(SELECT 1 FROM CT_AT_STUDENT_MARK
WHERE CT_AT_STUDENT_MARK.student_id = sr.student_id
AND CT_AT_STUDENT_MARK.event_id = sr.event_id
AND CT_AT_STUDENT_MARK.week = sr.week)

SELECT
 student_unique_name,
 mark_name
FROM ATTENDANCE.REGISTER_MARK
WHERE event_instance_id = '2496-5'
ORDER BY student_unique_name
```
_.student_unique_name | _.mark_name
--- | ---
Dougherty, Barbara | Present
Godsall, Tracey | Present
Holmes, Lisa | Late (authorised)
Hullah, Kathleen | Present
Potts, Patricia | Present
Price, Michelle | Withdrawn
